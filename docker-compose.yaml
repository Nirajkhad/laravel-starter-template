x-queue-base: &queue-base
  build:
    context: .
    dockerfile: .docker/Dockerfile
    args:
      HOST_UID: ${HOST_UID}
      HOST_GID: ${HOST_GID}
  volumes:
    - .:/var/www/html
  env_file:
    - .env
  environment:
    RUN_APP_SETUP: "false"
  depends_on:
    - redis
    - postgres
  restart: unless-stopped
  networks:
    - laravel_network

services:
  ####################################
  # App (Octane)
  ####################################
  app:
    <<: *queue-base
    environment:
      RUN_APP_SETUP: "true"
    command: >
      php artisan octane:start
      --server=frankenphp
      --host=0.0.0.0
      --port=8080
      --watch
    ports:
      - "8000:8080"
    volumes:
      - .:/var/www/html
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: ["CMD", "healthcheck-octane"]
      start_period: 10s

  ####################################
  # Scheduler
  ####################################
  scheduler:
    <<: *queue-base
    command: scheduler
    environment:
      RUN_APP_SETUP: "false"

  ####################################
  # Queue Workers
  ####################################
  queue-default:
    <<: *queue-base
    command: >
      php artisan queue:work redis
      --queue=default
      --sleep=3
      --tries=3
      --timeout=90
      --max-time=3600
    environment:
      RUN_APP_SETUP: "false"

  ####################################
  # Infrastructure
  ####################################
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: laravel
      POSTGRES_USER: laravel
      POSTGRES_PASSWORD: secret
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - laravel_network

  redis:
    image: redis:7-alpine
    volumes:
      - redisdata:/data
    networks:
      - laravel_network

  mailpit:
    image: axllent/mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - laravel_network

volumes:
  pgdata:
  redisdata:
  caddy_data:
  caddy_config:

networks:
  laravel_network:
